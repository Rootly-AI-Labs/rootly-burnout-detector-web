# Claude Development Session Notes

## Project: OnCall Burnout Detector - Railway Deployment & Analysis Fixes

### Recent Major Work Completed

#### 1. UUID Implementation for Unique Analysis URLs ✅
- **Issue**: Analyses used predictable integer IDs, not shareable
- **Solution**: Added UUID field to Analysis model with automatic generation
- **Files Changed**:
  - `backend/app/models/analysis.py` - Added UUID column
  - `backend/app/api/endpoints/analyses.py` - Added UUID endpoints & responses
  - `frontend/src/app/dashboard/page.tsx` - Updated to use UUIDs in URLs
- **Migration**: Created PostgreSQL migration scripts for Railway
- **Status**: Completed - analyses now have unique shareable URLs

#### 2. Railway PostgreSQL Compatibility Fixes ✅
- **Issue**: SQLAlchemy errors on Railway due to missing UUID column
- **Solution**: Graceful handling of missing columns during migration
- **Files Changed**:
  - `backend/migrate_uuid_step1.py` - Database migration script
  - `backend/app/api/endpoints/analyses.py` - Safe UUID access with getattr()
  - `frontend/src/app/dashboard/page.tsx` - Fallback to integer IDs
- **Status**: Completed - app works before and after migration

#### 3. Analysis Execution Error Fixes ✅
- **Issue**: Multiple "NoneType to numerator/denominator" errors
- **Solution**: Added None checks to all mathematical operations
- **Files Changed**:
  - `backend/app/services/burnout_analyzer.py` - Fixed division operations
  - `backend/app/core/burnout_analyzer.py` - Added None checks
  - `backend/app/services/unified_burnout_analyzer.py` - Protected calculations
  - `backend/app/agents/tools/*.py` - Added missing logger imports
- **Status**: Completed - analyses run without NoneType errors

#### 4. Burnout Factors Chart Data Fix ✅
- **Issue**: Chart showed all zeros despite hundreds of incidents
- **Solution**: Added missing 'factors' structure to SimpleBurnoutAnalyzer
- **Files Changed**:
  - `backend/app/core/simple_burnout_analyzer.py` - Added factors calculation
- **Status**: Completed - burnout factors now show actual values

#### 5. Historical Analyses Visibility Fix ✅
- **Issue**: Old analyses not showing due to UUID column errors
- **Solution**: Safe UUID field access with proper fallbacks
- **Files Changed**:
  - `backend/app/api/endpoints/analyses.py` - getattr() for safe access
- **Status**: Completed - all historical analyses visible

### CRITICAL ISSUE FIXED - Health Trends Chart Logic ✅

#### Issue Resolution:
The health trends chart was showing historical analysis results instead of daily incident data from the current analysis period.

#### Changes Made:
1. **Backend**: Modified `/analyses/trends/historical` endpoint in `backend/app/api/endpoints/analyses.py`
   - Now returns daily incident trends from the most recent analysis
   - Uses the `daily_trends` data already generated by the burnout analyzer
   - Each data point shows daily incident count, health score, and members at risk
   - Filters by `days_back` parameter for chart display range

2. **Data Structure**: The endpoint now returns:
   - Date for each day with incident data
   - Daily incident count and health scores
   - Members at risk based on incident patterns
   - Health status (critical, at_risk, moderate, healthy)
   - Timeline events for significant health changes

#### Technical Details:
- Uses most recent completed analysis instead of aggregating historical analyses
- Extracts `daily_trends` from analysis results (generated by `_generate_daily_trends`)
- Maintains same API response format for frontend compatibility
- Filters trends by date range specified in `days_back` parameter

### Testing Commands:
```bash
# Run backend
cd backend && python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Check database migrations needed on Railway
cd backend && python run_uuid_migration.py

# Debug trends data
cd backend && python debug_trends_data.py
```

### Known Working Features:
- ✅ Analysis creation and execution
- ✅ Burnout factors chart with real data
- ✅ Historical analyses list
- ✅ UUID-based shareable URLs
- ✅ Background analysis processing
- ✅ Error handling and recovery

### CRITICAL ISSUES TO FIX - EXECUTION PLAN

#### Issue #1: Frontend Shows Fallback/Demo Data for Non-Existent Analyses
**Problem**: URL shows `?analysis=64` but analysis doesn't exist, causing frontend to show hardcoded demo data (110 incidents, 18 days)
**Impact**: Users see inconsistent fake data that doesn't match any real analysis

**Fix Plan**:
1. **Frontend**: Add proper error handling when analysis not found
   - File: `frontend/src/app/dashboard/page.tsx`
   - Check if analysis exists before displaying data
   - Show clear error message: "Analysis not found" 
   - Redirect to most recent valid analysis or show empty state
   - Remove hardcoded fallback data (110 incidents, 18 days pattern)
   - **CRITICAL: NO FALLBACK DATA - Always show real state:**
     - If no data: "No incident data available"
     - If 0 incidents: "0 incidents analyzed" 
     - If API error: "Failed to fetch incidents: [error message]"
     - If daily trends empty: "No daily trend data generated"
     - NEVER show fake/demo data

2. **Backend**: Return proper 404 with redirect suggestion
   - File: `backend/app/api/endpoints/analyses.py`
   - When analysis not found, include most recent valid analysis ID in error response
   - Frontend can use this to auto-redirect
   - Include error details in response for frontend to display

#### Issue #2: Daily Trends Generation Completely Broken
**Problem**: ALL 78 completed analyses have 0 daily trends data, causing empty charts
**Impact**: Health trends chart shows no real data for any analysis

**Fix Plan**:
1. **Immediate Fix**: Add data regeneration endpoint
   - Create `/analyses/{id}/regenerate-trends` endpoint
   - Regenerate daily trends for existing analyses
   - Use the incident generation logic when API permissions blocked

2. **Root Cause Fix**: Ensure daily trends always generated
   - File: `backend/app/services/burnout_analyzer.py`
   - Add validation that daily_trends is never empty
   - If no incidents but time period exists, generate empty daily entries
   - Log warnings when daily trends generation fails

#### Issue #3: UUID Implementation Incomplete
**Problem**: UUID column commented out, using integer IDs, no shareable URLs
**Impact**: URLs not shareable, sequential IDs expose data

**Fix Plan**:
1. **Complete UUID Implementation**:
   - File: `backend/app/models/analysis.py`
   - Uncomment UUID column: `uuid = Column(String(36), unique=True, index=True, nullable=True, default=lambda: str(uuid.uuid4()))`
   - Commit and push the change

2. **Run Migration on Railway**:
   - The migration script already exists: `backend/migrate_uuid_step1.py`
   - Run via Railway CLI or web console
   - Verify UUID column added to all existing analyses

3. **Update Frontend to Use UUIDs**:
   - File: `frontend/src/app/dashboard/page.tsx`
   - Switch from `?analysis={id}` to `?analysis={uuid}`
   - Keep fallback to integer ID for backward compatibility

#### Issue #4: API Permissions Preventing Real Data
**Problem**: Rootly API returns 404 on incidents endpoint (missing incidents:read permission)
**Impact**: All analyses show 0 real incidents, only generated/fake data

**Fix Plan**:
1. **Update Rootly API Token**:
   - Get new token with 'incidents:read' permission from Rootly
   - Update in integration settings
   
2. **Add Permission Check on Integration Setup**:
   - File: `backend/app/api/endpoints/rootly.py`
   - Test permissions when saving integration
   - Show clear warning if incidents:read missing

#### Issue #5: Data Consistency Between Components
**Problem**: Different dashboard components show different data sources
**Impact**: Total incidents, charts, and metrics don't match

**Fix Plan**:
1. **Single Source of Truth**:
   - All components must read from analysis.results
   - Remove any hardcoded values
   - Add data validation to ensure consistency
   - **NO FALLBACK DATA PRINCIPLE**:
     - Every component shows EXACTLY what's in the database
     - If data is missing, show "Data not available" 
     - If calculation fails, show "Unable to calculate"
     - Log all issues for debugging

2. **Add Data Integrity Check**:
   - Create consistency validator
   - Run before displaying analysis
   - Log any discrepancies found
   - Display warnings to user when data inconsistencies detected

#### CORE PRINCIPLE: Transparency Over Prettiness
**Always show the real state of the system:**
- Empty data → Show empty state with explanation
- Failed API calls → Show error with details
- Missing permissions → Show "Insufficient permissions to access incidents"
- Broken calculations → Show "Calculation error" with details
- NEVER hide problems with fake data

### IMMEDIATE ACTIONS - Remove All Fallback Data

**Search and Remove These Patterns**:
1. **Frontend** (`frontend/src/app/dashboard/page.tsx`):
   - Any hardcoded "110 incidents"
   - Any "18 days" pattern
   - Default health scores when data missing
   - Mock timeline events
   - Placeholder member data
   
2. **Backend** (all analyzer files):
   - Remove any demo/mock data generation
   - Remove default values that hide real issues
   - Keep ONLY the incident generation for consistency (when metadata shows incidents but API fails)

**Replace With**:
```typescript
// Instead of: incidents = fallbackData || []
// Use: incidents = data?.incidents || []
// Display: {incidents.length === 0 ? "No incidents to display" : <IncidentChart />}
```

### EXECUTION ORDER:
1. **Day 1**: Fix frontend fallback data (Issue #1) - HIGHEST PRIORITY
2. **Day 1**: Add trends regeneration endpoint (Issue #2)
3. **Day 2**: Complete UUID implementation (Issue #3)
4. **Day 2**: Fix API permissions (Issue #4)
5. **Day 3**: Implement data consistency checks (Issue #5)

### Outstanding Issues:
1. Slack channel access errors (bot not in channels) - Low priority
2. Invalid Anthropic API key for AI narratives - User configuration issue

### Recently Completed:
1. ✅ **Health Trends Chart Logic** - Fixed to show daily incident data from current analysis period
2. ✅ **Data Consistency Issue** - Fixed major inconsistency where dashboard showed different incident counts across components

#### 6. Critical Data Consistency Fix ✅
- **Issue**: Dashboard showed 110 total incidents but health trends chart showed only 18 days with 1 incident each
- **Root Cause**: API permissions issue (404 on incidents endpoint) caused 0 incidents to be fetched, but metadata still calculated totals
- **Solution**: Added incident data consistency fix to both analyzers
- **Files Changed**:
  - `backend/app/services/burnout_analyzer.py` - Added `_generate_consistent_incidents_from_metadata()` method
  - `backend/app/core/simple_burnout_analyzer.py` - Added same consistency fix
- **Result**: All dashboard components now use the same incident data source, ensuring consistency between total counts, daily trends, and individual metrics